<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金蝶云单点登录</title>
    <meta name="description" content="金蝶云单点登录应用 - 纯静态版本">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0069d9;
            --success-color: #28a745;
            --success-dark: #218838;
            --danger-color: #dc3545;
            --danger-dark: #c82333;
            --warning-color: #ffc107;
            --warning-dark: #e0a800;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-color: #dee2e6;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-hover: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        h1 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            color: var(--gray-color);
            font-size: 1.1rem;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .card-header {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 15px;
        }
        
        h2 {
            color: var(--dark-color);
            margin-bottom: 0;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            outline: 0;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: var(--shadow);
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: var(--success-dark);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: var(--danger-dark);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: var(--warning-dark);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .result {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            text-align: center;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--light-color);
            border-radius: 6px 6px 0 0;
            margin-bottom: -1px;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 16px 20px;
            transition: 0.3s;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-color);
        }
        
        .tab button:hover {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }
        
        .tab button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            background-color: white;
        }
        
        .config-section {
            margin-bottom: 30px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .environment-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .environment-selector select {
            flex: 1;
            min-width: 200px;
        }
        
        .recent-users {
            margin-top: 15px;
        }
        
        .recent-users-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        
        .recent-users-list li {
            padding: 12px 15px;
            background-color: var(--light-color);
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .recent-users-list li:hover {
            background-color: var(--light-gray);
        }
        
        .remove-user {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .remove-user:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .instructions {
            background-color: #e9f7fe;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 0 4px 4px 0;
            margin: 20px 0;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .environment-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>金蝶云单点登录</h1>
            <p class="subtitle">纯静态版本</p>
        </header>
        
        <main>
            <div class="card">
                <div class="tab">
                    <button class="tablinks active" onclick="openTab(event, 'config')">系统配置</button>
                    <button class="tablinks" onclick="openTab(event, 'login')">用户登录</button>
                </div>
                
                <div id="config" class="tabcontent" style="display: block;">
                    <div class="card-header">
                        <h2>系统配置</h2>
                    </div>
                    
                    <div class="environment-selector">
                        <label for="environmentSelect">环境选择:</label>
                        <select id="environmentSelect" onchange="loadEnvironmentConfig()">
                            <option value="default">默认环境</option>
                        </select>
                        <button class="btn btn-sm" onclick="addNewEnvironment()">新增环境</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEnvironment()">删除环境</button>
                    </div>
                    
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="X_KDAPI_ACCTID">账户ID (X_KDAPI_ACCTID):</label>
                            <input type="text" id="X_KDAPI_ACCTID" placeholder="请输入账户ID">
                        </div>
                        
                        <div class="form-group">
                            <label for="X_KDAPI_APPID">应用ID (X_KDAPI_APPID):</label>
                            <input type="text" id="X_KDAPI_APPID" placeholder="请输入应用ID">
                        </div>
                        
                        <div class="form-group">
                            <label for="X_KDAPI_APPSEC">应用密钥 (X_KDAPI_APPSEC):</label>
                            <input type="password" id="X_KDAPI_APPSEC" placeholder="请输入应用密钥">
                        </div>
                        
                        <div class="form-group">
                            <label for="X_KDAPI_SERVERURL">服务器URL (X_KDAPI_SERVERURL):</label>
                            <input type="text" id="X_KDAPI_SERVERURL" placeholder="例如: https://your-server.kingdee.com/">
                        </div>
                        
                        <div class="form-group">
                            <label for="X_KDAPI_LCID">语言ID (X_KDAPI_LCID):</label>
                            <select id="X_KDAPI_LCID">
                                <option value="2052">2052 - 简体中文</option>
                                <option value="1033">1033 - English</option>
                                <option value="1028">1028 - 繁體中文</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="saveConfig()">保存配置</button>
                        <button class="btn" onclick="loadConfig()" style="margin-left: 10px;">加载已保存配置</button>
                        <button class="btn btn-success" onclick="testConfig()" style="margin-left: 10px;">测试配置</button>
                    </div>
                </div>
                
                <div id="login" class="tabcontent">
                    <div class="card-header">
                        <h2>用户登录</h2>
                    </div>
                    
                    <div class="form-group">
                        <label for="username">用户名:</label>
                        <input type="text" id="username" placeholder="请输入用户名" oninput="filterRecentUsers()">
                    </div>
                    
                    <div class="recent-users">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label>最近使用的用户:</label>
                            <button class="btn btn-sm btn-warning" onclick="clearRecentUsers()">清空历史</button>
                        </div>
                        <ul id="recentUsersList" class="recent-users-list">
                            <!-- 最近用户列表将通过JavaScript动态填充 -->
                        </ul>
                    </div>
                    
                    <button class="btn btn-block" onclick="performSSO()">执行单点登录</button>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>正在生成签名并跳转...</p>
                    </div>
                    
                    <div class="result alert-success" id="successResult">
                        <p>正在跳转到金蝶云系统...</p>
                    </div>
                    
                    <div class="result alert-danger" id="errorResult">
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>使用说明</h2>
                </div>
                <div class="instructions">
                    <h3>操作指南</h3>
                    <ol>
                        <li><strong>系统配置</strong>：
                            <ul>
                                <li>在"系统配置"标签页中选择或创建环境</li>
                                <li>填写金蝶云系统的配置信息</li>
                                <li>点击"保存配置"按钮保存当前环境配置</li>
                            </ul>
                        </li>
                        <li><strong>用户登录</strong>：
                            <ul>
                                <li>切换到"用户登录"标签页</li>
                                <li>从最近使用的用户列表中选择或输入新用户名</li>
                                <li>点击"执行单点登录"按钮</li>
                            </ul>
                        </li>
                        <li><strong>自动跳转</strong>：系统将自动计算签名并在新窗口中打开金蝶云系统</li>
                    </ol>
                </div>
                <p><strong>注意：</strong>所有配置信息和用户名历史将保存在浏览器本地存储中，不会上传到任何服务器。</p>
                <p><strong>纯静态版本：</strong>此版本不依赖任何后端服务，所有计算均在浏览器端完成，无请求资源消耗。</p>
            </div>
        </main>
        
        <footer>
            <p>金蝶云单点登录 &copy; 2025 | 纯静态版本</p>
        </footer>
    </div>

    <script>
        // 页面加载时初始化
        window.onload = function() {
            loadEnvironmentList();
            loadEnvironmentConfig();
            loadRecentUsers();
            
            // 注册 Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        };
        
        // Tab切换功能
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // 加载环境列表
        function loadEnvironmentList() {
            const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
            const select = document.getElementById('environmentSelect');
            
            // 保存当前选中值
            const currentValue = select.value;
            
            // 清空选项
            select.innerHTML = '<option value="default">默认环境</option>';
            
            // 添加所有环境
            Object.keys(environments).forEach(envName => {
                if (envName !== 'default') {
                    const option = document.createElement('option');
                    option.value = envName;
                    option.textContent = envName;
                    select.appendChild(option);
                }
            });
            
            // 恢复选中值
            if (currentValue && environments[currentValue]) {
                select.value = currentValue;
            }
        }
        
        // 添加新环境
        function addNewEnvironment() {
            const envName = prompt('请输入新环境的名称:');
            if (envName) {
                const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
                if (!environments[envName]) {
                    environments[envName] = {};
                    localStorage.setItem('kingdee_environments', JSON.stringify(environments));
                    loadEnvironmentList();
                    document.getElementById('environmentSelect').value = envName;
                    loadEnvironmentConfig();
                } else {
                    alert('环境名称已存在');
                }
            }
        }
        
        // 删除当前环境
        function deleteEnvironment() {
            const select = document.getElementById('environmentSelect');
            const envName = select.value;
            
            if (envName === 'default') {
                alert('不能删除默认环境');
                return;
            }
            
            if (confirm(`确定要删除环境 "${envName}" 吗？`)) {
                const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
                delete environments[envName];
                localStorage.setItem('kingdee_environments', JSON.stringify(environments));
                select.value = 'default';
                loadEnvironmentList();
                loadEnvironmentConfig();
            }
        }
        
        // 保存配置到当前环境
        function saveConfig() {
            const select = document.getElementById('environmentSelect');
            const envName = select.value;
            
            const config = {
                X_KDAPI_ACCTID: document.getElementById('X_KDAPI_ACCTID').value,
                X_KDAPI_APPID: document.getElementById('X_KDAPI_APPID').value,
                X_KDAPI_APPSEC: document.getElementById('X_KDAPI_APPSEC').value,
                X_KDAPI_SERVERURL: document.getElementById('X_KDAPI_SERVERURL').value,
                X_KDAPI_LCID: document.getElementById('X_KDAPI_LCID').value
            };
            
            const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
            environments[envName] = config;
            localStorage.setItem('kingdee_environments', JSON.stringify(environments));
            
            alert(`"${envName}" 环境配置已保存`);
        }
        
        // 加载当前环境配置
        function loadEnvironmentConfig() {
            const select = document.getElementById('environmentSelect');
            const envName = select.value;
            
            const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
            const config = environments[envName] || {};
            
            document.getElementById('X_KDAPI_ACCTID').value = config.X_KDAPI_ACCTID || '';
            document.getElementById('X_KDAPI_APPID').value = config.X_KDAPI_APPID || '';
            document.getElementById('X_KDAPI_APPSEC').value = config.X_KDAPI_APPSEC || '';
            document.getElementById('X_KDAPI_SERVERURL').value = config.X_KDAPI_SERVERURL || '';
            document.getElementById('X_KDAPI_LCID').value = config.X_KDAPI_LCID || '2052';
        }
        
        // 加载配置（兼容旧版本）
        function loadConfig() {
            loadEnvironmentConfig();
            alert('已加载当前环境配置');
        }
        
        // 测试配置
        function testConfig() {
            const config = {
                X_KDAPI_ACCTID: document.getElementById('X_KDAPI_ACCTID').value,
                X_KDAPI_APPID: document.getElementById('X_KDAPI_APPID').value,
                X_KDAPI_APPSEC: document.getElementById('X_KDAPI_APPSEC').value,
                X_KDAPI_SERVERURL: document.getElementById('X_KDAPI_SERVERURL').value,
                X_KDAPI_LCID: document.getElementById('X_KDAPI_LCID').value
            };
            
            if (!config.X_KDAPI_ACCTID || !config.X_KDAPI_APPID || !config.X_KDAPI_APPSEC || !config.X_KDAPI_SERVERURL) {
                alert('请填写所有必填配置项');
                return;
            }
            
            alert('配置完整，可以进行登录操作');
        }
        
        // 执行单点登录
        function performSSO() {
            // 隐藏之前的结果
            hideResults();
            
            // 获取配置
            const select = document.getElementById('environmentSelect');
            const envName = select.value;
            const environments = JSON.parse(localStorage.getItem('kingdee_environments') || '{}');
            const config = environments[envName] || {};
            
            // 检查必要配置
            if (!config.X_KDAPI_ACCTID || !config.X_KDAPI_APPID || !config.X_KDAPI_APPSEC || !config.X_KDAPI_SERVERURL) {
                showError('请完善当前环境的所有系统配置项');
                return;
            }
            
            // 获取用户名
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showError('请输入用户名');
                return;
            }
            
            // 添加到最近使用的用户列表
            addRecentUser(username);
            
            // 显示加载状态
            document.getElementById('loading').style.display = 'block';
            
            try {
                // 构建SSO URL
                const redirectUrl = buildSSOUrl(config, username);
                
                // 显示成功消息
                document.getElementById('loading').style.display = 'none';
                document.getElementById('successResult').style.display = 'block';
                
                // 在新窗口中打开金蝶云系统
                setTimeout(() => {
                    const newWindow = window.open(redirectUrl, '_blank');
                    if (!newWindow) {
                        showError('弹窗被浏览器阻止，请允许弹窗后重试');
                        document.getElementById('successResult').style.display = 'none';
                    } else {
                        // 跳转成功后更新消息
                        document.getElementById('successResult').innerHTML = '<p>已在新窗口中打开金蝶云系统</p>';
                    }
                }, 1500);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError(error.message);
            }
        }
        
        // 最近使用的用户功能
        let recentUsers = [];
        
        // 加载最近使用的用户
        function loadRecentUsers() {
            try {
                recentUsers = JSON.parse(localStorage.getItem('kingdee_recent_users') || '[]');
            } catch (e) {
                console.error('解析最近用户数据失败:', e);
                recentUsers = [];
            }
            updateRecentUsersList();
        }
        
        // 添加到最近使用的用户
        function addRecentUser(username) {
            // 验证用户名
            if (!username || typeof username !== 'string') {
                return;
            }
            
            // 移除已存在的相同用户名
            recentUsers = recentUsers.filter(user => user !== username);
            // 添加到开头
            recentUsers.unshift(username);
            // 限制数量为10个
            if (recentUsers.length > 10) {
                recentUsers = recentUsers.slice(0, 10);
            }
            // 保存到本地存储
            try {
                localStorage.setItem('kingdee_recent_users', JSON.stringify(recentUsers));
            } catch (e) {
                console.error('保存最近用户数据失败:', e);
            }
            // 更新显示
            updateRecentUsersList();
        }
        
        // 更新最近用户列表显示
        function updateRecentUsersList() {
            const listElement = document.getElementById('recentUsersList');
            if (!listElement) return;
            
            listElement.innerHTML = '';
            
            recentUsers.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span onclick="selectUser('${user.replace(/'/g, "\\\\'")}')">${user}</span>
                    <button class="remove-user" onclick="removeRecentUser('${user.replace(/'/g, "\\\\'")}')">&times;</button>
                `;
                listElement.appendChild(li);
            });
        }
        
        // 选择用户
        function selectUser(username) {
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.value = username;
            }
        }
        
        // 移除最近用户
        function removeRecentUser(username) {
            recentUsers = recentUsers.filter(user => user !== username);
            try {
                localStorage.setItem('kingdee_recent_users', JSON.stringify(recentUsers));
            } catch (e) {
                console.error('保存最近用户数据失败:', e);
            }
            updateRecentUsersList();
        }
        
        // 清空最近用户
        function clearRecentUsers() {
            if (confirm('确定要清空最近使用的用户历史吗？')) {
                recentUsers = [];
                try {
                    localStorage.removeItem('kingdee_recent_users');
                } catch (e) {
                    console.error('清除最近用户数据失败:', e);
                }
                updateRecentUsersList();
            }
        }
        
        // 过滤最近用户（根据输入内容）
        function filterRecentUsers() {
            const inputElement = document.getElementById('username');
            const listElement = document.getElementById('recentUsersList');
            if (!inputElement || !listElement) return;
            
            const input = inputElement.value.toLowerCase();
            const items = listElement.getElementsByTagName('li');
            
            for (let i = 0; i < items.length; i++) {
                const userNameElement = items[i].getElementsByTagName('span')[0];
                if (userNameElement) {
                    const userName = userNameElement.textContent.toLowerCase();
                    if (userName.includes(input)) {
                        items[i].style.display = '';
                    } else {
                        items[i].style.display = 'none';
                    }
                }
            }
        }
        
        // 构建单点登录URL
        function buildSSOUrl(env, username) {
            // 从环境变量获取配置
            const dbId = env.X_KDAPI_ACCTID || "";
            const appId = env.X_KDAPI_APPID || "";
            const appSecret = env.X_KDAPI_APPSEC || "";
            const lcId = env.X_KDAPI_LCID || "2052"; // 默认简体中文
            const serverUrl = env.X_KDAPI_SERVERURL || "";
            
            if (!username) {
                throw new Error("Username is required");
            }
            
            if (!dbId || !appId || !appSecret || !serverUrl) {
                throw new Error("Missing required configuration in environment variables: dbId, appId, appSecret, and serverUrl must be set");
            }
            
            const timestamp = Math.floor(Date.now() / 1000);
            const strArray = [dbId, username, appId, appSecret, timestamp.toString()];
            strArray.sort();
            
            // 与Java版本保持完全一致的字符串拼接方式
            let combStr = "";
            for (let i = 0; i < strArray.length; i++) {
                combStr += strArray[i];
            }
            
            // 使用更可靠的SHA1实现
            const strSign = sha1Hash(combStr);
            const sign = Array.from(new Uint8Array(strSign))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('')
                .toUpperCase();
            
            // 构建参数字符串，与Java版本保持一致
            const urlPara = `{dbid:'${dbId}',username:'${username}',appid:'${appId}',signeddata:'${sign}',timestamp:'${timestamp}',lcid:'${lcId}',origintype:'simpas',formid:'',formtype:'bill',pkid:''}`;
            
            // 确保serverUrl以/结尾，然后拼接路径
            const normalizedServerUrl = serverUrl.endsWith('/') ? serverUrl : serverUrl + '/';
            return normalizedServerUrl + "html5/Index.aspx?ud=" + encodeURIComponent(urlPara);
        }
        
        // SHA1哈希算法实现（修复版）
        function sha1Hash(data) {
            const msg = unescape(encodeURIComponent(data));
            let H = [0x67452301, 0xEFCDAB89, 0x98BADCFE, 0x10325476, 0xC3D2E1F0];
            
            let W = new Array(80);
            let a, b, c, d, e, i, j, T;
            
            // 将字符串转换为字节数组
            let msgLen = msg.length;
            let wordArray = [];
            for (i = 0; i < msgLen - 3; i += 4) {
                j = msg.charCodeAt(i) << 24 | msg.charCodeAt(i + 1) << 16 |
                    msg.charCodeAt(i + 2) << 8 | msg.charCodeAt(i + 3);
                wordArray.push(j);
            }
            
            switch (msgLen % 4) {
                case 0:
                    i = 0x080000000;
                    break;
                case 1:
                    i = msg.charCodeAt(msgLen - 1) << 24 | 0x0800000;
                    break;
                case 2:
                    i = msg.charCodeAt(msgLen - 2) << 24 | msg.charCodeAt(msgLen - 1) << 16 | 0x08000;
                    break;
                case 3:
                    i = msg.charCodeAt(msgLen - 3) << 24 | msg.charCodeAt(msgLen - 2) << 16 |
                        msg.charCodeAt(msgLen - 1) << 8 | 0x80;
                    break;
            }
            
            wordArray.push(i);
            
            while ((wordArray.length % 16) !== 14) wordArray.push(0);
            
            wordArray.push(msgLen >>> 29);
            wordArray.push((msgLen << 3) & 0x0ffffffff);
            
            for (i = 0; i < wordArray.length; i += 16) {
                for (j = 0; j < 16; j++) W[j] = wordArray[i + j];
                for (j = 16; j < 80; j++) W[j] = rotateLeft(W[j - 3] ^ W[j - 8] ^ W[j - 14] ^ W[j - 16], 1);
                
                a = H[0]; b = H[1]; c = H[2]; d = H[3]; e = H[4];
                
                for (j = 0; j < 80; j++) {
                    if (j < 20) {
                        T = (rotateLeft(a, 5) + (b & c | ~b & d) + e + W[j] + 0x5A827999) & 0x0ffffffff;
                    } else if (j < 40) {
                        T = (rotateLeft(a, 5) + (b ^ c ^ d) + e + W[j] + 0x6ED9EBA1) & 0x0ffffffff;
                    } else if (j < 60) {
                        T = (rotateLeft(a, 5) + (b & c | b & d | c & d) + e + W[j] + 0x8F1BBCDC) & 0x0ffffffff;
                    } else {
                        T = (rotateLeft(a, 5) + (b ^ c ^ d) + e + W[j] + 0xCA62C1D6) & 0x0ffffffff;
                    }
                    
                    e = d;
                    d = c;
                    c = rotateLeft(b, 30);
                    b = a;
                    a = T;
                }
                
                H[0] = (H[0] + a) & 0x0ffffffff;
                H[1] = (H[1] + b) & 0x0ffffffff;
                H[2] = (H[2] + c) & 0x0ffffffff;
                H[3] = (H[3] + d) & 0x0ffffffff;
                H[4] = (H[4] + e) & 0x0ffffffff;
            }
            
            // 创建返回的ArrayBuffer
            const result = new ArrayBuffer(20);
            const view = new DataView(result);
            view.setUint32(0, H[0], false);
            view.setUint32(4, H[1], false);
            view.setUint32(8, H[2], false);
            view.setUint32(12, H[3], false);
            view.setUint32(16, H[4], false);
            
            return result;
        }
        
        // 循环左移位操作
        function rotateLeft(value, shift) {
            return ((value << shift) | (value >>> (32 - shift))) & 0xFFFFFFFF;
        }
        
        // 隐藏所有结果
        function hideResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'none';
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
            }
            const errorResultElement = document.getElementById('errorResult');
            if (errorResultElement) {
                errorResultElement.style.display = 'block';
            }
        }
    </script>
</body>
</html>