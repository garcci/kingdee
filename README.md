# 金蝶云单点登录应用

这个项目提供了多种部署选项，包括纯静态网站版本和 Cloudflare Pages 版本。

## 目录结构

```
.
├── functions/              # Cloudflare Functions
│   └── sso.js             # SSO API 端点
├── public/                 # 静态资源目录
│   ├── app/               # 完整 Web 应用
│   │   └── index.html     # Web 界面
│   ├── _headers           # Cloudflare 缓存头配置
│   └── index.html         # API 文档和入口页面
├── _routes.json           # Cloudflare Pages 路由配置
├── index.html             # 纯静态网站版本
├── sw.js                  # Service Worker 文件，实现离线功能
├── manifest.json          # PWA 配置文件
└── worker.js              # 原始 Cloudflare Worker 实现（保留供参考）
```

## Cloudflare Pages 部署

### 部署方式
1. 将代码推送到 GitHub/GitLab/Bitbucket 仓库
2. 在 Cloudflare Pages 控制台中连接仓库
3. 设置以下构建配置：
   - 构建命令：`npm run build`（如果有的话）或留空
   - 输出目录：`dist`（如果有的话）或留空

### 路由结构
- `/` - API 文档和入口页面
- `/api/sso` - SSO API 端点
- `/app/` - 完整 Web 应用

### 环境变量配置
在 Cloudflare Pages 项目设置中配置以下环境变量：

- `X_KDAPI_ACCTID` - 金蝶云账户ID
- `X_KDAPI_APPID` - 应用ID
- `X_KDAPI_APPSEC` - 应用密钥
- `X_KDAPI_LCID` - 语言ID（默认为2052，即简体中文）
- `X_KDAPI_SERVERURL` - 金蝶云服务器URL
- `TEST_USER` - （可选）测试用户名

### API 使用方法
可以通过以下方式调用 SSO API：

1. 查询参数方式：
   ```
   GET /api/sso?user=john
   ```

2. 请求头方式：
   ```
   GET /api/sso
   x-user: john
   ```

系统将自动重定向到金蝶云系统。

### Cloudflare 缓存优化

#### 缓存策略
- **API 端点** (`/api/*`): 不缓存，确保每次请求都生成最新的签名
- **主页面** (`/` 和 `/app/`): 缓存1小时，提高页面加载速度
- **静态资源** (CSS, JS): 缓存24小时，最大化利用 CDN 优势

#### 缓存控制文件
通过 `public/_headers` 文件配置了详细的缓存策略：
```
# API 请求不缓存
/api/*
  Cache-Control: no-cache, no-store, must-revalidate

# 页面和静态资源缓存
/app/
  Cache-Control: public, max-age=3600
/app/*.js
  Cache-Control: public, max-age=86400
```

#### 缓存优势
1. **提高响应速度** - 静态资源由全球 CDN 节点提供服务
2. **降低源站压力** - 大部分请求在边缘节点处理
3. **智能缓存控制** - 对不同类型的资源采用不同的缓存策略
4. **即时更新** - API 请求始终获取最新数据，确保安全性

## 纯静态网站版本

### 离线功能说明

#### Service Worker
- 使用 Service Worker 实现离线缓存
- 首次访问后，应用可以完全离线使用
- 自动缓存核心文件，包括 [index.html](file:///Users/ziling/Library/Favorites/IdeaProjects/kingdee/index.html)
- 支持应用更新提示和无缝更新
- 增强了错误处理机制

#### PWA 支持
- 支持安装为桌面应用
- 可以添加到主屏幕
- 支持离线启动

### 使用方法

#### 直接使用
1. 用浏览器打开 `index.html` 文件
2. 首次访问时，Service Worker 会自动注册并缓存必要文件
3. 断开网络连接后仍可正常使用应用

#### 安装为桌面应用
1. 在支持 PWA 的浏览器中打开应用（如 Chrome、Edge）
2. 点击地址栏中的安装图标或通过浏览器菜单选择"安装应用"
3. 应用将作为独立应用安装到您的设备上

#### 环境管理
- **新增环境**：在"系统配置"标签页中点击"新增环境"按钮创建新环境
- **切换环境**：使用环境选择下拉菜单在不同环境间切换
- **删除环境**：选择要删除的环境后点击"删除环境"按钮
- **默认环境**：系统提供一个默认环境，无法删除

#### 配置项说明
- `X_KDAPI_ACCTID` - 金蝶云账户ID
- `X_KDAPI_APPID` - 应用ID
- `X_KDAPI_APPSEC` - 应用密钥
- `X_KDAPI_LCID` - 语言ID（默认为2052，即简体中文）
- `X_KDAPI_SERVERURL` - 金蝶云服务器URL

#### 用户登录
- 在"用户登录"标签页中选择最近使用的用户或输入新用户名
- 点击"执行单点登录"按钮完成登录
- 系统会在新窗口中打开金蝶云系统

## 特点

### Cloudflare Pages 版本
1. **无服务器架构** - 利用 Cloudflare Functions 实现后端逻辑
2. **全球加速** - 利用 Cloudflare 全球网络提供快速访问
3. **安全可靠** - 通过 Cloudflare 环境变量管理敏感配置
4. **灵活部署** - 支持 Git 驱动的自动部署
5. **双重访问方式** - 提供 API 端点和 Web 界面两种使用方式
6. **智能缓存** - 利用 Cloudflare CDN 和边缘缓存优化性能
7. **精细控制** - 通过 _headers 文件精确控制各类资源的缓存行为

### 纯静态网站版本
1. **纯静态网站** - 无需任何服务器支持，可在任何静态文件服务器上运行
2. **离线可用** - 使用 Service Worker 实现离线功能，首次加载后可完全离线使用
3. **PWA 支持** - 可安装为桌面应用，提供原生应用体验
4. **自动更新** - 当应用有新版本时会提示用户更新
5. **多环境支持** - 可以创建和管理多个环境配置（如开发、测试、生产环境）
6. **本地存储** - 所有配置信息和用户名历史保存在浏览器本地存储中，不会上传到任何服务器
7. **用户记忆功能** - 自动记忆最近使用的用户名，方便快速登录
8. **新窗口跳转** - 单点登录后在新窗口中打开金蝶云系统，保留原应用界面
9. **弹窗阻止处理** - 检测并提示浏览器弹窗阻止情况
10. **增强错误处理** - 增加了全面的错误处理和边界检查
11. **现代化UI设计** - 采用现代化的用户界面设计，提升用户体验
12. **完全兼容** - 保持了与原 Worker 版本相同的功能和加密逻辑
13. **用户友好** - 提供直观的界面，方便配置和使用

## 注意事项

1. 所有配置信息和用户名历史保存在浏览器本地存储中，更换浏览器或清除缓存后需要重新配置
2. SHA1 哈希算法实现与金蝶云系统要求保持一致
3. 此版本完全在浏览器中运行，不依赖任何后端服务
4. 为保证安全性，建议在受信任的环境中使用此工具
5. 离线功能需要浏览器支持 Service Worker（现代浏览器均支持）
6. 当有新版本可用时，页面顶部会显示更新提示
7. 跳转到金蝶云系统时会在新窗口打开，原应用界面保持不变
8. 如果浏览器阻止弹窗，请允许弹窗后重试